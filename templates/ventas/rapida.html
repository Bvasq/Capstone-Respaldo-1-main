{% extends "base.html" %}
{% block title %}Venta r√°pida{% endblock %}

{% block content %}
<h3 class="mb-3">Venta r√°pida</h3>

<div class="row g-3">
  <!-- Columna izquierda: buscador -->
  <div class="col-lg-6">
    <div class="input-group mb-2">
      <span class="input-group-text">üîé</span>
      <input id="buscador" class="form-control" placeholder="Buscar producto por nombre o SKU...">
    </div>
    <ul id="resultados" class="list-group"></ul>
  </div>

  <!-- Columna derecha: carrito -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Carrito</strong>
        <button id="btn-vaciar" class="btn btn-sm btn-outline-danger">Vaciar</button>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0" id="tabla-carrito">
          <thead>
            <tr>
              <th>Producto</th>
              <th style="width:110px">Cant.</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="total-box">Total: <span id="total">$0</span></div>
        <button id="btn-finalizar" class="btn btn-primary">Finalizar venta</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const csrftoken = document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))?.split('=')[1];
const input = document.querySelector('#buscador');
const resultados = document.querySelector('#resultados');
const tbody = document.querySelector('#tabla-carrito tbody');
const totalEl = document.querySelector('#total');
const btnVaciar = document.querySelector('#btn-vaciar');
let carrito = [];

// Renderizar carrito
function renderCarrito(){
  tbody.innerHTML = "";
  let total = 0;
  carrito.forEach((it, idx)=>{
    const subt = it.precio * it.cantidad;
    total += subt;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.nombre}<div class="small text-muted">${it.sku}</div></td>
      <td>
        <input data-idx="${idx}" type="number" min="1" value="${it.cantidad}"
               class="form-control form-control-sm qty">
      </td>
      <td>$${it.precio.toFixed(0)}</td>
      <td>$${subt.toFixed(0)}</td>
      <td>
        <button data-idx="${idx}" class="btn btn-sm btn-outline-danger del">‚úï</button>
      </td>`;
    tbody.appendChild(tr);
  });
  totalEl.textContent = "$" + total.toFixed(0);
}

// Cambiar cantidad
tbody.addEventListener('input', e=>{
  if(e.target.classList.contains('qty')){
    const i = +e.target.dataset.idx;
    carrito[i].cantidad = Math.max(1, parseInt(e.target.value || "1"));
    renderCarrito();
  }
});

// Eliminar √≠tem
tbody.addEventListener('click', e=>{
  if(e.target.classList.contains('del')){
    carrito.splice(+e.target.dataset.idx, 1);
    renderCarrito();
  }
});

// Vaciar carrito
btnVaciar.onclick = ()=>{
  carrito = [];
  renderCarrito();
};

// Buscar productos
input.addEventListener('input', async ()=>{
  const q = input.value.trim();
  resultados.innerHTML = "";
  if(!q) return;
  const res = await fetch("{% url 'ventas:buscar' %}?q=" + encodeURIComponent(q));
  const data = await res.json();
  data.results.forEach(p=>{
    const li = document.createElement('li');
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <div>
        <strong>${p.nombre}</strong>
        <div class="small text-muted">${p.sku} ‚Äî $${p.precio.toFixed(0)}</div>
      </div>
      <button class="btn btn-sm btn-primary">Agregar</button>`;
    li.querySelector('button').onclick = ()=>{
      const idx = carrito.findIndex(x=>x.id===p.id);
      if(idx>=0) carrito[idx].cantidad += 1;
      else carrito.push({
        id:p.id,
        sku:p.sku,
        nombre:p.nombre,
        precio:p.precio,
        cantidad:1
      });
      renderCarrito();
    };
    resultados.appendChild(li);
  });
});

// Finalizar venta + descarga de ticket
document.querySelector('#btn-finalizar').onclick = async ()=>{
  if(carrito.length===0) return alert("Agrega productos.");
  const res = await fetch("{% url 'ventas:confirmar' %}", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({items: carrito})
  });

  if(!res.ok) {
    const txt = await res.text();
    return alert(txt);
  }

  const data = await res.json();
  alert("Venta registrada. Total: $" + data.total.toFixed(0));

  // ---------- AQU√ç EST√Å EL CAMBIO IMPORTANTE ----------
  // Intentamos obtener la URL de descarga del ticket
  let ticketUrl = null;

  if (data.ticket_download_url) {
    // si tu vista confirmar_venta devuelve esto
    ticketUrl = data.ticket_download_url;
  } else if (data.ticket_url) {
    // o si devuelve ticket_url normal
    ticketUrl = data.ticket_url;
  } else if (data.venta_id) {
    // o en √∫ltimo caso, construimos la ruta /ventas/ticket/<id>/download/
    ticketUrl = `/ventas/ticket/${data.venta_id}/download/`;
  }

  // Si tenemos una URL, redirigimos para que el navegador DESCARGUE el .txt
  if (ticketUrl) {
    // en la vista ticket_txt_download pon:
    // Content-Disposition: attachment; filename="ticket_XX.txt"
    window.location.href = ticketUrl;
  }
  // ----------------------------------------------------

  carrito = [];
  renderCarrito();
  resultados.innerHTML = "";
  input.value = "";
};
</script>
{% endblock %}
